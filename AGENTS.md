# AGENTS.md

## 沟通与语言

- **所有回复必须使用中文**（包括代码评审意见、PR 评论、提交说明建议等）。
- 如需引用英文原文/报错信息可保留英文，但解释与结论仍用中文。

## 开发环境提示

### Node.js（使用 pnpm）

- 使用 `pnpm install --filter <project_name>` 将该包加入工作区依赖范围，确保 ESLint、TypeScript 等工具能正确识别。
- 创建新项目（Next.js + TypeScript）：

  - 推荐：`pnpm dlx create-next-app@latest <project_name> --ts`
  - 如需交互式选项，按提示选择即可（建议启用 ESLint、App Router 等，按项目约定为准）。

- 检查每个包内的 `package.json` 的 `name` 字段以确认正确的项目名（忽略根目录的 `package.json`）。
- 新增包要执行 pnpm add，不要直接修改 `package.json` 文件，保证包管理的一致性。

### Python（使用 uv）

- Python 相关依赖与环境统一使用 **uv** 管理（不要使用 pip/poetry/conda 作为主流程）。
- 常用命令示例：

  - 创建虚拟环境：`uv venv`
  - 安装依赖：`uv pip install -r requirements.txt`（或按项目约定的依赖文件）
  - 运行脚本：`uv run python <script.py>`

- 如果仓库中存在 `pyproject.toml` 锁文件，请优先遵循项目内既定的 uv 使用方式。

## 工作流编排

### 1. 计划节点默认策略

- 对任何非简单任务（3 个以上步骤或涉及架构决策）进入计划模式
- 如果过程中出现问题，立即停止并重新规划——不要硬着头皮继续
- 不仅在构建阶段使用计划模式，也要在验证步骤中使用
- 先写详细规格，减少歧义

### 2. 子代理策略

- 大量使用子代理，保持主上下文窗口整洁
- 将研究、探索和并行分析卸载给子代理
- 对复杂问题，通过子代理投入更多计算资源
- 每个子代理只处理一种思路，保证执行聚焦

### 3. 自我改进循环

- 每次用户纠正后：把该模式更新到 `tasks/lessons.md`
- 给自己写规则，防止重复犯同样的错误
- 持续严格迭代这些经验，直到错误率下降
- 每次会话开始时，回顾与当前项目相关的经验

### 4. 完成前验证

- 在证明可用之前，绝不要标记任务完成
- 在相关情况下，对比主分支与修改后的行为差异
- 问自己：“资深工程师会认可这个结果吗？”
- 运行测试、检查日志、展示正确性

### 5. 追求优雅（平衡）

- 对非简单改动：暂停并问自己“有没有更优雅的实现方式？”
- 如果修复方案看起来很 hack：问自己“基于现在掌握的一切，如何实现一个优雅方案？”
- 对简单、明显的修复可跳过此步骤——不要过度设计
- 在提交前主动挑战自己的实现

### 6. 自主修复 Bug

- 收到 Bug 报告后：直接修，不要等用户手把手指导
- 指出日志、错误信息、失败测试——然后解决它们
- 不需要用户来回切换上下文
- 遇到 CI 测试失败，直接去修复，不用等指示

## 任务管理

1. **先做计划**：把计划写到 `tasks/todo-<task-name>.md`，并使用可勾选项
2. **验证计划**：开始实现前先确认计划
3. **跟踪进度**：边做边勾选已完成项
4. **解释改动**：每一步都给出高层级总结
5. **记录结果**：在 `tasks/todo-<task-name>.md` 中添加复盘/评审部分
6. **沉淀经验**：在用户纠正后更新 `tasks/lessons.md`

## 核心原则

- **简单优先**：让每次改动尽可能简单，尽量减少改动范围。
- **拒绝偷懒**：找到根因，不做临时修补，按资深开发标准执行。
- **最小影响**：改动只触及必要部分，避免引入新 Bug。
